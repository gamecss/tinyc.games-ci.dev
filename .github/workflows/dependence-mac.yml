name: dependence-mac

on:
  push:
    branches: [ ci ]
  pull_request:
    branches: [ ci ]

jobs:
  sdl:
    runs-on: macos-latest

    steps:
      - name: Get sdl source
        run: |
          git clone https://github.com/SDL-mirror/SDL.git
          cd SDL
          git checkout $(git describe --tags `git rev-list --tags --max-count=1`)
      - name: Set Default Scheme
        working-directory: SDL/Xcode/SDL
        run: |
          sudo xcode-select -switch /Applications/Xcode_10.3.app/
          scheme_list=$(xcodebuild -list -json | tr -d "\n")
          default=$(echo $scheme_list | ruby -e "require 'json'; puts JSON.parse(STDIN.gets)['project']['targets'][0]")
          echo $default | cat >default
          echo Using default scheme: $default
      - name: Build
        working-directory: SDL/Xcode/SDL
        env:
          scheme: ${{ 'default' }}
        run: |
          if [[ $scheme = default ]]; then scheme=$(cat default); fi
          xcodebuild -scheme "$scheme" ONLY_ACTIVE_ARCH=NO -configuration 'Release'
          cp -r /Users/runner/Library/Developer/Xcode/DerivedData/SDL-gserqlkghybkaxdggwarbuabfcuy/Build/Products/Release/SDL2.framework ../../../SDL2.framework
  sdl_ttf:
    runs-on: macos-latest

    steps:
      - name: Get sdl_ttf source
        run: |
          git clone https://github.com/SDL-mirror/SDL_ttf.git
          cd SDL_ttf
          git checkout $(git describe --tags `git rev-list --tags --max-count=1`)
          mkdir build
      - name: prepare build
        working-directory: SDL_ttf
        run: | #cmake -E chdir build cmake -G Xcode -D BUILD_FRAMEWORK:BOOL=true .. #cmake .. -G "Xcode"
          ./configure CC="sh gcc-fat.sh"
     # - name: Set Default Scheme
     #   working-directory: SDL_ttf/build/
     #   run: |
      #    scheme_list=$(xcodebuild -list -json | tr -d "\n")
       #   default=$(echo $scheme_list | ruby -e "require 'json'; puts JSON.parse(STDIN.gets)['project']['targets'][0]")
      #    echo $default | cat >default
       #   echo Using default scheme: $default
     # - name: Build freetype
   #     run: |
   #       curl -o freetype.tar.gz https://sourceforge.net/projects/freetype/files/latest/download
 #         tar -zxvf freetype.tar.gz -C freetype
      - name: Build sdl_ttf
        working-directory: SDL_ttf
      #  env:
    #      scheme: ${{ 'default' }}
        run: |
          make
        #  if [[ $scheme = default ]]; then scheme=$(cat default); fi
       #   xcodebuild -scheme "$scheme" -configuration 'Release'
       # sudo xcode-select -switch /Applications/Xcode_10.3.app/          
        # cp -r /Users/runner/Library/Developer/Xcode/DerivedData/SDL-gserqlkghybkaxdggwarbuabfcuy/Build/Products/Release/SDL2.framework ../../../SDL2.framework
